# SVM 시스템 (운전보조시스템)
![SVM 시스템](https://user-images.githubusercontent.com/97617731/224349079-90ebf8b7-934b-4694-b366-b4db4ca5ee39.png)

> SVM(Surround View Monitor), 차량 주변 360도를 Top View로 확인하는 운전 보조 시스템

많은 운전자들이 자동차 주차 시 사각지대로 인해 어려움을 겪습니다. 이는 자동차의 크기가 클수록, 길이 좁아질수록 정도가 심해집니다.

이러한 문제점을 해결하고자 SVM(Surround View Monitor) 시스템은 차량의 전후좌우 4방향의 카메라 영상을 합성한 Top View 영상을 제공하여 주차 및 주행 시 사고를 줄이고 편리함을 제공합니다.


### 팀원
김기한, 김이랑, 김필재, 박주현(팀장), 임영선, 임진현

## 프로젝트 기간
2022.10.11 ~ 2022.11.21 (7주)

## 대표 기술스택
1. Language: Python(3.8.13)
2. Library : openCV (4.6.0)
3. IDE : Visual Studio Code (1.70.0)

## 주요기능
- 왜곡보정 및 이미지 정렬(화각 180°이상 카메라 이미지 보정)
- Top View 영상 이미지(2D) 제공
- 합성 경계 영역 처리
- 합성 이미지 밝기/색상 보정

## 세부기능
| 구분 | 기능                      | 설명                                                         |
| ---- | ------------------------- | ------------------------------------------------------------ |
| 1    | 왜곡 보정                 | 차량 카메라 영상의 압축되고 찌그러져 보이는 왜곡 현상 보정   |
| 2    | Top View 영상 이미지 제공 | 차량 카메라 영상 이미지의 옆에서 보는 시점을 위에서 내려다보는 시점으로 변환 |
| 3    | 합성 경계 영역 처리       | 시점변환까지 마친 차량 4방향의 영상 이미지를 하나의 이미지로 보일 수 있도록 정합 |
| 4    | 합성 이미지 색상 보정     | 4방향 합성 이미지가 더욱 자연스러운 하나의 이미지로 보일 수 있도록 블랜딩, 명도 조절 |
| 5    | 멀티 프로세싱             | FPS 최적화를 위해 기존 직렬 처리되어있던 하나의 프로세스를 5개의 프로세스로 나눠 병렬처리 |


## 프로젝트 파일 구조
```
📦7th_svm
├─ 📂camaraTool
├─ 📂data
│  ├─ 📂asset
│  ├─ 📂images
│  │  ├─ 📂extrinsic_images
│  │  ├─ 📂intrinsic_images
│  │  └─ 📂original_images
│  └─ 📂output
├─ 📂exec
├─ 📂extrinsicCalibration
├─ 📂intrinsicCalibration
├─ 📂imageManipulation
├─ 📜main.py
├─ 📜README.md
└─ 📜test.py
```



## 구현 과정

### 1. 왜곡보정
`화각 180°이상 카메라 이미지 보정 기능 (왜곡보정 및 이미지정렬)`

#### 이론 설명
`어안렌즈 이미지 왜곡보정(Camera Calibration)`
```
화각 180°이상 카메라 렌즈에서 찍은 영상은 상이 중앙에서 멀어질수록 압축되고 휘어지는 왜곡현상이 발생합니다. 
이 왜곡을 보정하기 위해 카메라 캘리브레이션 작업을 진행해 이미지를 보정했습니다. 

이 때, OpenCV 라이브러리와 체스보드를 활용해 왜곡계수를 구했고, 
왜곡행렬의 역행렬을 통해 반대로 이미지에 굴곡을 형성하여 왜곡을 보정했습니다. 
```

#### 처리 결과
![image](https://user-images.githubusercontent.com/97617731/224348806-e33d16d8-638f-4a00-b92b-1312263fe044.png)

### 2. 시점변환
`호모그래피 행렬을 적용한 Topview 시점 변환`

#### 이론 설명
`어안렌즈 이미지 왜곡보정(Camera Calibration)`

```python
하늘에서 내려다보는 시점으로 변환하기 위해, 호모그래피 변환 행렬을 계산한 비율모델을 적용했고, 
각 점들을 매칭시켜 시점 변환과정을 거쳤습니다


이 때 최종적으로 얻어야 하는 이미지에서 체스보드의 각 지점들이 위치될 절대좌표를 설정하고 
그에 따른 비율을 적용시켜서 실제 체스보드판을 바닥에 배치시켰습니다.

그 후 그 이미지를 촬영해서 체스보드안에 있는 95개의 각 지점들을 찾고, 
미리 정해놨던 그 절대좌표에 대응시켜 시점 변환까지 진행했습니다.

```
#### 처리 결과
![image](https://user-images.githubusercontent.com/97617731/224348927-d76bd450-1bc7-4c61-ad63-779d27248261.png)

### 3. 합성 / 색 보정
`전후좌우 이미지 합성 및 색 밸런싱`

#### 이론 설명
`이미지 합성`
```
차량의 전, 후, 좌, 우에서 4개의 시점변환 이미지를 얻은 후,합성과정을 진행했습니다. 
합성과정에서는 정합하고 연결해야 할 부분에 책과 같은 물체를 활용했습니다.

책들이 자연스럽게 연결될 수 있도록 절대좌표를 설정해 링크화 시켰고, 
네 개의 이미지가 하나의 이미지처럼 보일 수 있도록 좌표를 연결시켜
합성과정을 진행했습니다. 
```

`블랜딩 색 보정`
```
이미지 합성 결과, 네 개의 이미지가 자연스럽게 연결되었지만, 이미지들의 경계 부분에
선이 생기고 밝기가 일정하지 않아 하나의 이미지라고 보기 어려웠습니다.

그래서 이미지들의 겹치는 영역들에서 각 픽셀들의 RGB 값을 평균내고 적용시키는 
블랜딩 색 보정 작업을 진행했습니다.

또한 픽셀의 색상,채도,명도를 나타내는 HSV행렬을 전체 이미지에서 평균내어, 
특히 명도 값인 V값을 조절해 보다 깔끔하고 정확한 이미지를 얻어냈습니다.
```

#### 처리 결과
![image](https://user-images.githubusercontent.com/97617731/224348681-717ed45e-a82a-4789-965e-343843f754d4.png)![image](https://user-images.githubusercontent.com/97617731/224348727-69750ad9-19ae-4149-8843-231dfc56aabc.png)

### 4. FPS 최적화
`멀티프로세싱을 통한 FPS 최적화`

```
이미지 작업을 처리하고 여러 이미지를 만들어냈지만, SVM 이미지를 만들어낼 때
FPS(1초에 몇 개의 이미지를 만들어내는가) 수치가 5~7프레임이어서 영상이 끊겨 보였습니다.

그래서 기존 직렬 처리로 되어있던 하나의 프로세스를 여러 개로 나눠서 진행할 수 있도록
다섯개의 프로세스들로 나눠서 병렬처리 최적화를 진행했습니다

그 결과 초당 5~7 프레임 정도 나오던 영상이 19~20프레임으로 눈에 띄게 개선될 수 있었습니다.
```

#### 이론 설명

`Python 멀티프로세싱(Multiprocessing)`
```
파이썬의 멀티프로세싱(Multiprocessing)은 동시에 여러 개의 프로세스를 생성하고 실행하는 방식으로, 
파이썬의 기본적인 GIL(Global Interpreter Lock)을 우회하여 CPU를 더 효율적으로 사용할 수 있도록 도와줍니다.

멀티프로세싱은 파이썬의 multiprocessing 모듈을 사용하여 구현할 수 있습니다. 
이 모듈은 Process 클래스를 제공하여 쉽게 다중 프로세스를 생성하고 관리할 수 있습니다. 
각 프로세스는 별도의 인스턴스로 생성되며, start() 메서드로 실행됩니다. 
각 프로세스는 별도의 프로세스 ID(PID)를 가지며, 각각 독립적인 공간에서 코드를 실행합니다.

멀티프로세싱을 사용하면 CPU 바운드 작업을 처리할 때 빠른 속도를 보여주며, 동시에 여러 개의 작업을 처리할 수 있습니다. 
하지만 각 프로세스가 독립적으로 실행되기 때문에, 메모리 공간을 공유하기 위해 별도의 메커니즘을 사용해야 합니다. 
이를 위해 파이썬에서는 Queue, Pipe, Value, Array 등의 객체를 사용하여 프로세스 간 통신을 구현할 수 있습니다.
```

#### 처리 결과
![SVM 시스템](/uploads/3bb93b090a1ad9baf2e30661eecf5712/output.gif)
